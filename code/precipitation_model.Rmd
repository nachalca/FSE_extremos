---
title: "precipitation"
output: html_document
date: "2024-05-09"
---

```{r}
library("tidymodels")
library("data.table")
library("report")
library("gridExtra")
library("extremogram")
library("doParallel")
source("utils.R")
source("metrics.R")


reanalysis <- fread('reanalysis_precipitation_training_data.csv') |> filter(time < '2015-01-01') 
cmip_6 <- fread('cmip6_precipitation_to_downscale_data.csv') 
temp_1 <- fread('reanalysis_tas_training_data.csv') |> 
          mutate(date = getDate(time)) |>
          group_by(date) |>
          summarize(tas_max = max(tas), tas_min = min(tas))
temp <- fread('reanalysis_tas_training_data.csv') |> 
          mutate(date = getDate(time)) |>
          inner_join(temp_1, by=join_by(date)) |> select(-date)
  
wind <- fread('reanalysis_sfcWind_training_data.csv')
```

```{r}
res_to_plot <- reanalysis |> inner_join(cmip_6, by = join_by(time)) |> rename("obs_pr_daily" = "pr_daily.x", "cmip_pr_daily" = "pr_daily.y")

ggplot(res_to_plot) +
  geom_histogram(aes(x=obs_pr_daily), alpha=.5) +
  geom_histogram(aes(x=cmip_pr_daily), fill = "red", alpha=.5)

rm(res_to_plot) 
```

```{r}
reanalysis <- reanalysis |> 
                  mutate(date = getDate(time), hour = as.factor(getHour(time)), month = as.factor(getMonth(time))) |>
                  inner_join(temp, by = join_by(time)) |> 
                  inner_join(wind, by = join_by(time)) |> select(-c(sfcWind,date,pr))
```

```{r}
reanalysis_train <- reanalysis |> filter(time < as.Date('2014-01-01'))
reanalysis_test <- reanalysis |> filter(time >= as.Date('2014-01-01'))
```

```{r define_model, message=FALSE}
model_recipe <- recipe(tas ~ ., data = reanalysis_train) |>
                update_role(time, new_role = "ID") |>
                step_interact(~ hour:avg_tas)

model <- linear_reg() %>% set_engine("lm")

model_workflow <- 
  workflow() %>% 
  add_model(model) %>% 
  add_recipe(model_recipe)

model_fit <- fit(model_workflow, reanalysis_train)

predicted <- predict(model_fit, reanalysis_test)
```

```{r}
engine <- extract_fit_engine(model_fit)
#Hours are statistically significant, as is their interaction with the avg_sfcWinderature; months are not. 
engine |> report_table()
```



```{r}
xgb_recipe <- recipe(tas ~ ., data = reanalysis_train) |>
                update_role(time, new_role = "ID") |>
                step_dummy(all_nominal()) 
                

xgb_model <- boost_tree(
  trees = 1000,
  tree_depth = tune(), min_n = tune(),
  loss_reduction = tune(),                     ## first three: model complexity
  sample_size = tune(), mtry = tune(),         ## randomness
  learn_rate = tune()                          ## step size
) %>%
  set_engine("xgboost") %>%
  set_mode("regression")

xgb_wf <- workflow() %>%
  add_recipe(xgb_recipe) %>%
  add_model(xgb_model)

xgb_grid <- grid_latin_hypercube(
  tree_depth(),
  min_n(),
  loss_reduction(),
  sample_size = sample_prop(),
  finalize(mtry(), reanalysis_train),
  learn_rate(),
  size = 20
)

xgb_folds <- vfold_cv(reanalysis_train)

cl <- makeCluster(4)
registerDoParallel(cl)

xgb_tune_res <- tune_grid(
  xgb_wf,
  resamples = xgb_folds,
  grid = xgb_grid,
  control = control_grid(save_pred = TRUE)
)


### USE THE BEST XGBOOST
xgb_best <- select_best(xgb_tune_res, "rmse")

xgb_workflow <- xgb_wf |> finalize_workflow(xgb_best)

xgb_fit <- fit(xgb_workflow, reanalysis_train)

xgb_predicted <- predict(xgb_fit, reanalysis_test)
```

```{r}
res <- reanalysis_test |> rename("obs_tas" = "tas") |>
        cbind(xgb_predicted) |>
        rename("xgb_tas" = ".pred") |>
        cbind(predicted) |>
        rename("nv_tas" = ".pred")
```

```{r show_plot, echo=FALSE}
res_to_plot <- res[1:96,]

ggplot(res_to_plot, aes(x=time)) +
  geom_line(aes(y=obs_tas)) +
  geom_line(aes(y=xgb_tas), color = "red") 
  xlab("")
```

```{r}
rbind( 
  metrics(res$time, res$obs_tas, res$xgb_tas, "xgboost"),
  metrics(res$time, res$obs_tas, res$nv_tas, "nv")
)
```

```{r}
res_to_plot <- res |> 
    select(!ends_with("avg_tas")) |>
    pivot_longer(
     cols = ends_with("_tas"),
     names_to = "model",
     names_pattern = "(.*)_tas",
     values_to = "tas",
     values_drop_na = TRUE
    ) 
  
ggplot(res_to_plot, aes(x=tas, color = model))+
  geom_density()
```