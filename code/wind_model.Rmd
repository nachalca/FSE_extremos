# Wind model

Work in progress, don't pay attention.

## Naive Model

Analagous to the temp model.

$$y_{ih} = \beta_0 + \beta_{1h} + \beta_{2m} + \beta_3*avg\_sfcWind + \beta_{4h}*avg\_sfcWind + \epsilon_i $$
The data was generated in the notebook `prepare_data.ipnyb`

```{r load_packages, results='hide', message=FALSE}
library("tidymodels")
library("data.table")
library("report")
library("gridExtra")
library("extremogram")
source("utils.R")
source("metrics.R")

reanalysis <- fread('reanalysis_sfcWind_training_data.csv') 

cmip_6 <- fread('cmip6_sfcWind_to_downscale_data.csv') 
```

```{r define_model, message=FALSE}
model_recipe <- recipe(sfcWind ~ ., data = reanalysis) |>
                update_role(time, new_role = "ID") |>
                step_mutate(hour = as.factor(getHour(time)), month = as.factor(getMonth(time))) |>
                step_dummy(all_integer()) |>
                step_interact(~ hour:avg_sfcWind)

model <- linear_reg() %>% set_engine("lm")

model_workflow <- 
  workflow() %>% 
  add_model(model) %>% 
  add_recipe(model_recipe)

model_fit <- fit(model_workflow, reanalysis)


predicted <- predict(model_fit, cmip_6)
cmip_6$sfcWind <- predicted$.pred

```

## Results

Hours are statistically significant, as is their interaction with the avg_sfcWinderature; months are not. 

```{r show_summary, echo=FALSE}
engine <- extract_fit_engine(model_fit)
#Hours are statistically significant, as is their interaction with the avg_sfcWinderature; months are not. 
engine |> report_table()
```

```{r show_metrics, echo=FALSE}

res <-  reanalysis |>
  select(time, sfcWind, avg_sfcWind) |>
  inner_join(cmip_6, by = join_by(time)) |>
  rename("obs_sfcWind" = "sfcWind.x", "nv_sfcWind" = "sfcWind.y", "obs_avg_sfcWind" = "avg_sfcWind.x", "cmip_avg_sfcWind" = "avg_sfcWind.y")

predictions <- fread('predictions_2.csv') |>
              mutate(hour = as.factor(hour)) |>
              select(-avg_sfcWind, -hour)  

res <-  res |>
  inner_join(predictions, by = join_by(time)) |>
  rename("knnr_sfcWind" = "sfcWind")
```

Plot (hourly) of three days.

```{r show_plot, echo=FALSE}
res_to_plot <- res[0:72,]

p1 <- ggplot(res_to_plot, aes(x=time)) +
  geom_line(aes(y=obs_sfcWind)) +
  geom_line(aes(y=nv_sfcWind), color = "red") + 
  geom_line(aes(y=obs_avg_sfcWind), linetype="dotted", color = "black") +
  geom_line(aes(y=cmip_avg_sfcWind), linetype="dotted", color = "red") +
  labs(y = "sfcWind", x = "")
  
p2 <- ggplot(res_to_plot, aes(x=time)) +
  geom_line(aes(y=obs_sfcWind)) +
  geom_line(aes(y=knnr_sfcWind), color = "red") + 
  geom_line(aes(y=obs_avg_sfcWind), linetype="dotted", color = "black") +
  geom_line(aes(y=cmip_avg_sfcWind), linetype="dotted", color = "red") +
  labs(y = "sfcWind", x = "")

grid.arrange(p1, p2, nrow = 1)
```

```{r }
res |> rmse(obs_sfcWind, nv_sfcWind) |> select(.estimate) |> as.numeric()
res |> mape(obs_sfcWind, nv_sfcWind) |> select(.estimate) |> as.numeric()
sign_correlation(res$obs_sfcWind, res$nv_sfcWind)
amplitude_rmse(res$time, res$obs_sfcWind, res$nv_sfcWind)
amplitude_mape(res$time, res$obs_sfcWind, res$nv_sfcWind)
maximum_correlation(res$time, res$obs_sfcWind, res$nv_sfcWind)
maximum_difference(res$time, res$obs_sfcWind, res$nv_sfcWind)

res |> rmse(obs_sfcWind, knnr_sfcWind) |> select(.estimate) |> as.numeric()
res |> mape(obs_sfcWind, knnr_sfcWind) |> select(.estimate) |> as.numeric()
sign_correlation(res$obs_sfcWind, res$knnr_sfcWind)
amplitude_rmse(res$time, res$obs_sfcWind, res$knnr_sfcWind)
amplitude_mape(res$time, res$obs_sfcWind, res$knnr_sfcWind)
maximum_correlation(res$time, res$obs_sfcWind, res$knnr_sfcWind)
maximum_difference(res$time, res$obs_sfcWind, res$knnr_sfcWind)
```

## Extremograms

```{r}
ggplot(res, aes(x=nv_sfcWind))+
  geom_density()
```