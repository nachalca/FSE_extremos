---
title: "`r paste0('Model evaluation for ', params$variable)`"
header-includes:
   - \usepackage{bbm}
params:
  variable: "tas" #Use pr as default
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
```

```{css}
/* Define a margin before h2 element */
h2 {
  margin-top: 3em;
}
```

```{r imports, include=FALSE}
library(here)
library(tidyverse)
library(gt)
library(plotly)
library(yaml)
library("extremogram")
source(here('code/metrics.R'))
source(here('code/utils.R'))
```

```{r load_data}
# params <- vector(mode = 'list')
# params$variable <- 'tas' 

res <- paste0('data/model_evaluation_data/', params$variable, ".csv") |> here() |> read.csv()  
#Load configuration
conf <- yaml.load_file(here("code/conf.yml"))
```



The observations for the validation were taken from `r min(res$time)` to `r max(res$time)`.

Remember that we have on a daily scale the variables `sfcWind`, `tas`, `pr`, `tasmax`, `tasmin` and `psl` and in a monthly scale `clt`, `rsdt`,`rsds` as a predictors. We also have the month `r  if (conf[["VARIABLES"]][[params$variable]][["daily"]]) {", hour, sun's elevation & azimuth"}` and the daily daylight amount in seconds as a predictors too.

```{r metrics_paired}
models <- res |> select(-c("time", "reanalysis")) |> colnames()

mfile <- here(paste0("reports/model_evaluation/", params$variable, "_numericmetrix.rds"))

if (file.exists(mfile)) { 
  tabla <- readRDS(mfile) 
} else {
  if(conf[["VARIABLES"]][[params$variable]][["daily"]]){
    if(params$variable == "pr"){
      r <- lapply(models, function(x) {
        metrics_paired_hourly_rain(time = res$time, truth = res$reanalysis, estimate = res[[x]], model = x)
      })    
    } else {
        r <- lapply(models, function(x) {
      metrics_paired_hourly(time = res$time, truth = res$reanalysis, estimate = res[[x]], model = x)
    })    
  }
  } else {
  r <- lapply(models, function(x) {
    metrics_paired_daily(time = res$time, truth = res$reanalysis, estimate = res[[x]], model = x)
  })  
 }
 tabla <- do.call(rbind, r) |>
  mutate(across(where(is.numeric), \(x) round(x, digits = 3) ) ) # |>  select()
  saveRDS(tabla, mfile)
}

# vector indicating if the metric is an error(-1), a gof (1), or a ratio (0)
metr.dir <- rep(1, length(names(tabla)) )
metr.dir[grep('mae', names(tabla))] <- -1
metr.dir[grep('ratio', names(tabla)) ] <- 0


data.frame(Metric = names(tabla), t(tabla)) |> 
  mutate( dr = metr.dir ) |>  # error direction
  as_tibble() |>  
  gt(  ) |>
  fmt_number(
    columns = everything(),
    decimals = 2
  ) |> 
  data_color(
    columns = -Metric, 
    method = 'numeric',
    direction = 'row',
    fn = fncol) |> 
      cols_hide(dr)
```

## Plots

```{r qqplot}
# pps <- (0:99+.5)/100
# plqq <- res |> 
#   pivot_longer(cols = -c(1:2), values_to = 'value', 
#                names_to = 'model') |> 
#   group_by(model) |> 
#   reframe(qq.obs  = quantile(reanalysis, probs = pps),
#           qq.pred = quantile(value, probs = pps, na.rm = TRUE),
#           per = pps) |> 
#   ggplot() + 
#   geom_line(aes( y=qq.pred-qq.obs, x=per, color=model)) + 
#   geom_hline(yintercept = 0, linetype='dashed') + 
#   scale_color_brewer(palette = 'Dark2') + 
#   theme_bw() 
plqq <- detrend_qq(res)
```


```{r maximum}
# if (conf[["VARIABLES"]][[params$variable]][["daily"]]) {
#   res.mx <- res |> 
#   pivot_longer(-time, names_to = 'model', values_to = 'vs')  |> 
#   mutate( date = ymd_hms(time) - hours(3) ) |> 
#   mutate(dd = as_date(date), hh = hour(date)) |> 
#   group_by(dd, model) |> 
#   mutate(mx = max(vs) ) |> 
#   ungroup() |> 
#   filter(vs == mx) #|> 
#   #select(model, dd, mx, hh)
  
# pl.mx <- ggplot() +
#   geom_bar(data=filter(res.mx, model =='reanalysis'), 
#            mapping = aes(x=hh), fill='grey') +
#   geom_freqpoly(data= filter(res.mx, model !='reanalysis'),
#             mapping = aes(x=hh, color=model) ) +
#   scale_color_brewer(palette = 'Dark2') + 
#   theme_bw() 
# }

pl.mx <- hour_max_plot(res)
```

```{r hourly_distribution}
if (conf[["VARIABLES"]][[params$variable]][["daily"]]) {
  pl.hourly_distribution <- hourly_distribution(res)
} else { 
  pl.hourly_distribution <- week_distribution(res)
}

```

```{r amplitude_plot}
if (conf[["VARIABLES"]][[params$variable]][["daily"]]) {
  pl.amplitude <- amplitude_plot(res)
} else { 
  pl.amplitude <- amplitude_monthly_plot(res)
}
```

```{r acf}
pl.acf <- acf_plot(res)
```

*Important:* Right now we are only estimating the upper tail extremogram. Currently we didn't find a way to estimate the two tales at the same time. We are using `quant = .97`

```{r extremogram}
pl.ext <- extremogram_plot(res)
```

```{r, fig.height=11, fig.width=11}
# (plqq | pl.mx) / (pl.acf | pl.ext) +  plot_layout(guides = 'collect')
annotations = list( 
  list( 
    x = 0.15,  
    y = 1.0,  
    text = "Detrended QQ-plot",  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ),  
  list( 
    x = 0.5,  
    y = 1,  
    text = "Extremogram",  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ),  
  list( 
    x = 0.85,  
    y = 1,  
    text = "Autocorrelogram",  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  )
)
f1 <- ggplotly(plqq) |> style(showlegend=FALSE) ; 
f2<-ggplotly(pl.ext) |> style(showlegend=FALSE) ; 
f3 <- ggplotly(pl.acf); 
s1 <- subplot(
        f1, f2, f3, 
        nrows=1, titleY = TRUE, titleX = TRUE, shareX=FALSE, shareY=FALSE, margin=.05
      ) |> 
      layout(annotations = annotations, coloraxis=list( colorscale='Dark2' ))



if (conf[["VARIABLES"]][[params$variable]][["daily"]]) {
  annotations = list( 
    list( 
    x = 0.25,  
    y = 1.0,  
    text = "Max hour per day",  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ),  
  list( 
    x = 0.75,  
    y = 1,  
    text = "Daily amplitude",  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  )  
)
f4<- ggplotly(pl.mx) |> style(showlegend=FALSE)  
f5 <- ggplotly(pl.amplitude) |> style(showlegend=FALSE) 
s2 <- subplot(f4, f5, nrows=1, titleY = TRUE, titleX = TRUE, margin=.05) |>
        layout(annotations = annotations, coloraxis=list( colorscale='Dark2' )) 
} else {
  f5 <- ggplotly(pl.amplitude) |> style(showlegend=FALSE) 
  s2 <- subplot(f5, nrows=1, titleY = TRUE, titleX = TRUE, margin=.05) |>
        layout(coloraxis=list( colorscale='Dark2' )) 
}

if (conf[["VARIABLES"]][[params$variable]][["daily"]]) {
  tt <- "Hourly Average"
} else {
  tt <- "Weekly Average"
} 

annotations = list( 
  list( 
    x = 0.5,  
    y = 1.0,  
    text = tt,  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  )
)
f6 <- ggplotly(pl.hourly_distribution) |> style(showlegend=FALSE) 
s3 <- subplot(f6, nrows=1, titleY = TRUE, titleX = TRUE, margin=.05) |>
        layout(annotations = annotations, coloraxis=list( colorscale='Dark2' ))


subplot(s1, s2, s3, nrows=3, titleY = TRUE, titleX = TRUE, margin=.05) |> 
   layout(coloraxis=list( colorscale='Dark2' ) )

```


